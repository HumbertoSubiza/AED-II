---
title: 
author:
date: 
output:
#  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(MASS)
```

---

## Capítulo 3 - Visualização de dados com _ggplot2()_

## a - Conceitos, elementos e primeiro gráfico

---

#### Filosofia da "Gramática dos Gráficos" - Grammar of Graphics, Leland Wilkinson, 1999

##### princípios básicos:

   - o gráfico está composto de diferentes camadas de elementos
   
   - a mensagem nos gráficos se obtém adicionando camadas de elementos estéticos

O gráfico é um mapeamento de dados, a partir de atributos estéticos de objetos geométricos

 Baseado nesses conceitos, Hadley Wickman em _Layered Grammar of Graphics_, estabelece que um gráfico pode ser construído a partir de camadas que são adicionadas sucessivamente.

 Assim surgiu o pacote **ggplot2** (Create Elegant Data Visualisations Using the Grammar of Graphics) de Hadley Wickman e Winston Chang (ver na ajuda _?ggplot2_ ).
 
---
 

##### **Elementos básicos no gráfico**

|  Elemento        |          Descrição                                     |
|------------------|--------------------------------------------------------|
| Dados (data)    | dados a serem apresentados|
| Estetica (aesthetics)|     atributos estéticos como posição, forma, cor, ...|
| Geometrias (Geometries)|   Os elementos visuais com os quais representamos os dados (pontos, linhas, barras,...)|

---

##### **Elementos complementares**

|  Elemento        |          Descrição                                   |
|------------------|------------------------------------------------------|
| Fatores (Facets)   |         Gráficos múltiplos por categoria|
| Estatísticas (Statistics)|   Representação dos dados para ajudar na compreensão|
| Coordenadas (coordinates) |  O espaço onde os dados serão representados|
| Temas (themes) |             Aparência ou aspecto|

---

#### primeiro gráfico

---

Nos exercícios a seguir, toda instrução que tenha a 

#### **_<span style="color:blue">seguinte formatação</span>_**

é para sua execução no fragmento de código R que segue ou na consola do RStudio (janela 3).

---

**Template para gráficos com ggplot**

      ggplot (data = <DADOS>, aes(<MAPPINGS>)) +
        
        <GEOM_FUNCTION>

---


#### Ordenamentos dos dados

    dados + aesthetics + 
      geometrias    + 
      fatores       + 
      estatísticas  + 
      coordenadas   +
      temas

Nos próximos exemplos começaremos com um gráfico simples até apresentar um gráfico elaborado e, como diz Hadley, "elegante", perfeitamente adequado para a publicação, inclusão num relatório ou trabalho acadêmico.

---

#### 1- gráfico simples

Vamos fazer um gráfico de um conjunto de dados da biblioteca **MASS**, que contém a média de peso corporal e do cérebro de 62 animais mamíferos.

Para o gráfico vamos indicar ao **ggplot** que vamos trabalhar com o dataframe **mammals** e no eixo "x" vamos colocar o peso do corpo e no eixo "y" o do cérebro.


```{r  aedII_1_01, message=FALSE}
library(MASS)
ggplot(mammals, aes(x = body, y = brain)) + # estes são os dados e o mapeamento
  geom_point() # camada de geometria adicionada, no caso, pontos
```

No gráfico acima temos apenas duas camadas: os dados na primeira e o tipo de representação na segunda, apenas pontos. O **ggplot** vai escolher por nós o resto dos elementos como cor dos pontos, limites dos eixos, legendas e aspecto do gráfico. Todos esses elementos e muitos outros podem ser personalizados como veremos mais adiante.

---

**_<span style="color:blue">Exercício, experimente na consola executar apenas a primeira linha do mapeamento dos dados. O que acontece e porquê? Coloque a segunda camada e veja o resultado,</span>_**

---

#### 2- gráfico com linha de regressão

Adicionamos às camadas anteriores uma camada complementar de estatística, o gráfico da linha simples de regressão linear. 

Notem que não é necessário fazer nenhum tipo de cálculo prévio, apenas incluir na camada que a metodologia é **"lm"** e indicar uma cor vermelha para o traçado e que não vamos precisar do intervalo de confiança da regressão, indicado por **"se = F"**. A adição de **_smooth** na chamada da estatística, introduz um fator de suavizado na linha graficada (ver a ajuda).

Além disso será adicionada uma transparência aos pontos graficados para melhor visualização de sobreposição.

---

```{r aedII_02}
ggplot(mammals, aes(x = body, y = brain)) +
  geom_point(alpha = 0.6) +
  stat_smooth(method = "lm", col = "red", se = F)
```

---

Analisado o gráfico pareceria que os dados necessitam de uma transformação nas unidades, já que existe disparidade de valores e concentração dos valores menores. 

Uma transformação log pode resolver o problema. Para manter a relação de unidades entre os eixos, adicionamos uma camada **coord_fixed()**, que por padrão vai manter a relação y/x = 1.

Na sequência transforma-se os eixos com log10 e finalmente adiciona-se a linha de regressão, indicando  a cor em sistema RGB de representação e o tamanho como 1.

---

#### 3- gráfico com transformação da escala para melhor representação


```{r aedII_03}
ggplot(mammals, aes(x = body, y = brain)) +
  geom_point(alpha = 0.6) +
  coord_fixed()           +
  scale_x_log10()         +
  scale_y_log10()         +
  stat_smooth(method = "lm", 
              col    = "#C42126", 
              se     = F,
              size   = 1)
```

Nota-se que a transformação melhorou o aspecto do gráfico e o análise dos dados, já que a relação entre as variáveis era logarítmica.

---

#### Para publicação, com padronização dos intervalos de escala em ambos eixos

Para deixar finalmente nosso gráfico num formato adequado para publicação e apresentação, será necessário padronizar os intervalos em ambos eixos, adicionar um título e subtítulo, indicando a fonte de donde os dados foram obtidos e finalmente deixar o gráfico apenas em preto e branco, já que muitas editoras não permitem outras cores, sem fundo colorido nem grade.

---

```{r aedII_04}
library(scales)
ggplot(mammals, aes(x = body, y = brain)) +                     # dados
  geom_point(size = 1.8, alpha = 0.6) +                        # tipo de geometria
  coord_fixed(xlim = c(10^-3, 10^4), ylim = c(10^-1, 10^4)) + # escala em ambos eixos
    annotation_logticks() +      # adiciona espaços cada vez menores, faz sentido apenas para eixos log
  scale_x_log10(expression ("Peso Corporal (log" ["10"]*" (Kg))"),      # escala logaritmica "x", titulo
                  breaks = trans_breaks("log10", function(x) 10^x),     # intervalos
                  labels = trans_format("log10", math_format(10^.x))) + # etiquetas
  scale_y_log10(expression ("Peso Cerebro (log" ["10"]*" (g))"),        # escala logaritmica "y", titulo
                  breaks = trans_breaks("log10", function(x) 10^x),     # intervalos
                  labels = trans_format("log10", math_format(10^.x))) + # etiquetas
    stat_smooth(method = "lm",  # linha de regressão
              col      = "black",   # cor
              se       = F,          # sem intervalo de confiança
              size     = 1) +      # tamanh0
  labs(title    = " Relação entre peso do cerebro e do corpo - 62 mamiferos", # título e sub
       subtitle = "Fonte: pacote R::MASS ") +
  theme_classic()                                                        # tema de fundo
```

---

###Adicionando todas as camadas num gráfico. 

Já vimos que um gráfico na metodologia **ggplot** se compõe de diferentes camadas. Por questões de simplicidade clareza, a ordem de adição das camadas é:

####Ordenamentos dos dados
 **dados + aesthetics + geometrias + fatores + estatísticas + coordenadas + temas**

#### Um exemplo completo:

Os dados a serem usados são de **datasets::iris** e contém medições de sépala e pétalas de 50 amostras de três especies da flor **iris** (ver artigo na wikipedia <https://en.wikipedia.org/wiki/Iris_flower_data_set>).


##### 1- conhecendo os dados: iris 

---

```{r aedII_05}
head(iris)
str(iris)
```

--- 

Os dados a serem graficados serão os que pertencem às primeiras e segunda coluna (variáveis) e correspondem à largura e comprimento da sépala das três espécies. Assim sendo, o argumento estético do mapeamento dos valores vai ser

**aes(x = Sepal.Length, y = Sepal.Width)**

A _primeira camada_ contendo os dados e mapeamento dos valores (aesthetics) é:

---

```{r aedII_06}
ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width))
```

---

A _segunda camada_ corresponde a geometria que representará os dados, neste caso, pontos. Para melhorar a visualização vamos permitir um pequeno deslocamento dos pontos que se sobrepõem. Isso é feito através de **geom_jitter**, que é uma variação de **geom_point**. Adicionamos uma transparência 0.6, que permite distinguir os pontos sobrepostos, isso é feito na própria camada de geometria.

---

```{r aedII_07}
ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width)) +
  geom_jitter(alpha = 0.6)
```

---

A _terceira camada_ incorpora uma linha de regressão, na cor vermelha e sem intervalo de confiança (se = F).

---

```{r aedII_08}
ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width)) +
  geom_jitter(alpha = 0.6) +
  stat_smooth(method = "lm", se = F, col = "red")
```

---

Como temos três espécies diferentes no gráfico (setosa, versicolor e virginica), a linha de regressão não é representativa dos diferentes grupos, precisamos de uma regressão por espécie.

---

A _quarta camada_ vai permitir dividir os dados por espécies (fatores) e apresentar três gráficos separados, um para cada espécie. 

Isto permite comparar as distribuições e valores para cada espécie, além de apresentar as linhas de regressão por separado. 

A fatorização dos dados e a divisão em três gráfico é feita com a camada **facet_grid**, indicando no primeiro argumento com o ponto "**.**", os dados a serem fatorizados (que vem da primeira camada) e sendo o segundo argumento o critério ou coluna usada como fator.

---

```{r aedII_09}
ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width)) +
  geom_jitter(alpha = 0.6) +
  stat_smooth(method = "lm", se = F, col = "red") +
    facet_grid(. ~ Species) 
```

---

Na _quinta camada_ (coordenadas) vamos incluir escalas de coordenadas personalizadas

 ver  ajuda para **scale_x_continuos, scale_y_continuos e coord_equal**

Com isto colocamos todos os gráficos na mesma escala numérica e de aparência. Note que nas camadas **scale**, colocamos a legenda de cada eixo, os limites e a distância do eixo que serão colocados (veja ajuda para mais detalhes).

---

```{r aedII_10, warning=FALSE}
ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width)) +
  geom_jitter(alpha = 0.6) +
  facet_grid(. ~ Species)  +
  stat_smooth(method = "lm", se = F, col = "red") +
  scale_x_continuous("Comprimento Sepal (cm)",
                     limits = c(3,8),
                     expand = c(0.2,0.1)) +
  scale_y_continuous("Largura Sepal (cm)",
                     limits = c(2,5),
                     expand = c(0.2,0.1)) +
  coord_equal()
```

---

Finalmente na _sexta camada_ adicionamos um tema ou aparença personalizada, no caso adicionamos um tema já preexistente no pacote o, **theme_light**.

---

```{r aedII_11, warning=FALSE}
ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width)) +
  geom_jitter(alpha = 0.6) +
  facet_grid(. ~ Species)  +
  stat_smooth(method = "lm", se = F, col = "red") +
  scale_x_continuous("Comprimento Sepal (cm)",
                     limits = c(3,8),
                     expand = c(0.2,0.1)) +
  scale_y_continuous("Largura Sepal (cm)",
                     limits = c(3,8),
                     expand = c(0.2,0.1)) +
  coord_equal() +
  theme_light()

```

---

FIM DA PRIMEIRA PARTE

---

```{r}
sessionInfo()
save(list = ls(), file = "01_ggplot2_all.Rdata")
```

